<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>微博登录与发帖工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f9f9f9;
    }
    .header {
      text-align: center;
      margin-bottom: 1rem;
    }
    input, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #0056b3;
    }
    .qrcode, .status, .logout, .post {
      background: white;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    img {
      display: block;
      margin: 0 auto;
      max-width: 300px;
    }
    pre {
      background: #eee;
      padding: 1rem;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>微博登录与发帖工具</h2>
  </div>

  <div style="margin-bottom: 1rem; text-align: center;">
    <input type="text" id="tokenInput" placeholder="请输入 API Token" />
  </div>

  <div class="status">
    <h3>登录状态</h3>
    <pre id="statusText">加载中...</pre>
    <button id="logoutBtn">退出登录</button>
  </div>

  <div class="qrcode">
    <h3>扫码登录</h3>
    <button id="getQrCodeBtn">获取二维码</button>
    <img id="qrImage" src="" alt="二维码" />
    <button id="checkScanStatusBtn">检查扫码状态</button>
  </div>

  <div class="post">
    <h3>发微博</h3>
    <textarea id="postText" placeholder="请输入微博内容..."></textarea>
    <button id="postBtn">发布</button>
  </div>

  <script>
    class WeiboProxy {
      constructor() {
        this.qrid = null;
        this.init();
      }

      getToken() {
        const tokenInput = document.getElementById('tokenInput');
        const value = tokenInput ? tokenInput.value.trim() : '';
        if (value) localStorage.setItem('apiToken', value);
        return value;
      }

      async init() {
        const savedToken = localStorage.getItem('apiToken');
        if (savedToken) {
          document.getElementById('tokenInput').value = savedToken;
        }

        await this.checkStatus();

        document.getElementById('getQrCodeBtn').onclick = () => this.getQRCode();
        document.getElementById('checkScanStatusBtn').onclick = () => this.checkScanStatus();
        document.getElementById('logoutBtn').onclick = () => this.logout();
        document.getElementById('postBtn').onclick = () => this.postWeibo();
      }

      async checkStatus() {
        const statusText = document.getElementById('statusText');
        try {
          const res = await fetch('/api/status', {
            headers: {
              'Authorization': 'Bearer ' + this.getToken()
            }
          });
          const data = await res.json();
          statusText.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          statusText.textContent = '错误: ' + err.message;
        }
      }

      async getQRCode() {
        try {
          const res = await fetch('/api/qrcode', {
            headers: {
              'Authorization': 'Bearer ' + this.getToken()
            }
          });
          const data = await res.json();
          this.qrid = data.qrid;
          document.getElementById('qrImage').src = data.qrurl;
        } catch (err) {
          alert('获取二维码失败: ' + err.message);
        }
      }

      async checkScanStatus() {
        if (!this.qrid) return alert('请先获取二维码');
        try {
          const res = await fetch('/api/scan-status?qrid=' + this.qrid, {
            headers: {
              'Authorization': 'Bearer ' + this.getToken()
            }
          });
          const data = await res.json();
          alert(data.message || JSON.stringify(data));
          await this.checkStatus();
        } catch (err) {
          alert('扫码状态获取失败: ' + err.message);
        }
      }

      async logout() {
        try {
          await fetch('/api/logout', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + this.getToken()
            }
          });
          await this.checkStatus();
          alert('已退出登录');
        } catch (err) {
          alert('退出失败: ' + err.message);
        }
      }

      async postWeibo() {
        const text = document.getElementById('postText').value;
        if (!text.trim()) return alert('请输入内容');
        try {
          const res = await fetch('/api/post', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + this.getToken(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text })
          });
          const data = await res.json();
          alert(data.message || JSON.stringify(data));
        } catch (err) {
          alert('发帖失败: ' + err.message);
        }
      }
    }

    new WeiboProxy();
  </script>
</body>
</html>
