<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微博助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            margin: 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }

        .header p {
            color: #666;
            font-size: 0.9rem;
        }

        .section {
            margin-bottom: 1.5rem;
        }

        .section h2 {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: bold;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-decoration: none;
            text-align: center;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: #5a6cdb;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #f0f2f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e0e2e5;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .qr-code-section {
            text-align: center;
            margin-top: 1.5rem;
        }

        .qr-code-section img {
            width: 200px;
            height: 200px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .status-message {
            text-align: center;
            margin-top: 1rem;
            font-size: 1rem;
            color: #555;
        }

        .char-count {
            font-size: 0.85rem;
            color: #777;
            text-align: right;
            margin-top: 0.5rem;
        }

        .char-count.warning {
            color: orange;
        }

        .char-count.error {
            color: red;
            font-weight: bold;
        }

        .alert-container {
            margin-top: 1rem;
            min-height: 30px; /* 确保有足够的空间显示消息 */
        }

        .alert {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .token-section {
            display: none; /* 默认隐藏 */
        }

        .main-app-section {
            display: none; /* 默认隐藏 */
        }

        .login-section {
            display: none; /* 默认隐藏 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>微博助手</h1>
            <p>通过代理服务发布微博和管理会话</p>
        </div>

        <div id="alertContainer" class="alert-container"></div>

        <div id="tokenSection" class="section token-section">
            <h2>配置 API Token</h2>
            <div class="form-group">
                <label for="tokenInput">API Token:</label>
                <input type="text" id="tokenInput" placeholder="请输入您的 API Token">
            </div>
            <button id="saveTokenBtn" class="btn btn-primary">保存 Token</button>
            <p class="status-message" id="tokenStatus">未配置</p>
        </div>

        <div id="mainAppSection" class="section main-app-section">
            <h2>发布微博</h2>
            <div class="form-group">
                <label for="weiboContent">微博内容 (140字以内):</label>
                <textarea id="weiboContent" placeholder="在此输入您想发布的微博内容"></textarea>
                <div id="charCount" class="char-count">0/140</div>
            </div>
            <button id="postWeiboBtn" class="btn btn-primary">发布微博</button>
            
            <h2 style="margin-top: 2rem;">会话管理</h2>
            <p class="status-message">当前登录状态: <span id="loginStatus">检测中...</span></p>
            <button id="refreshQrBtn" class="btn btn-secondary" style="margin-right: 10px;">刷新二维码</button>
            <button id="clearSessionBtn" class="btn btn-danger">清除会话</button>
        </div>

        <div id="loginSection" class="section login-section">
            <h2>登录</h2>
            <div class="qr-code-section">
                <img id="qrcodeImage" src="" alt="微博登录二维码" style="display: none;">
                <p id="qrcodeMessage" class="status-message">点击“刷新二维码”获取二维码</p>
            </div>
        </div>
    </div>

    <script>
        class WeiboProxy {
            constructor() {
                this.apiBaseUrl = window.location.origin; // 使用当前页面的源作为 API 基础 URL
                this.apiToken = localStorage.getItem('weibo_proxy_token');
                this.isLoggedIn = false;
                this.initElements();
                this.bindEvents();
                this.init();
            }

            initElements() {
                this.tokenSection = document.getElementById('tokenSection');
                this.tokenInput = document.getElementById('tokenInput');
                this.saveTokenBtn = document.getElementById('saveTokenBtn');
                this.tokenStatusEl = document.getElementById('tokenStatus');
                
                this.mainAppSection = document.getElementById('mainAppSection');
                this.weiboContentInput = document.getElementById('weiboContent');
                this.postWeiboBtn = document.getElementById('postWeiboBtn');
                this.charCountEl = document.getElementById('charCount');
                this.loginStatusEl = document.getElementById('loginStatus');
                this.refreshQrBtn = document.getElementById('refreshQrBtn');
                this.clearSessionBtn = document.getElementById('clearSessionBtn');

                this.loginSection = document.getElementById('loginSection');
                this.qrcodeImage = document.getElementById('qrcodeImage');
                this.qrcodeMessage = document.getElementById('qrcodeMessage');
            }

            bindEvents() {
                this.saveTokenBtn.addEventListener('click', () => this.saveToken());
                this.postWeiboBtn.addEventListener('click', () => this.postWeibo());
                this.weiboContentInput.addEventListener('input', (e) => this.updateCharCount(e.target.value));
                this.refreshQrBtn.addEventListener('click', () => this.getQRCode());
                this.clearSessionBtn.addEventListener('click', () => this.clearSession());
            }

            async init() {
                this.clearAlerts();
                if (!this.apiToken) {
                    this.showTokenSection();
                    this.showAlert('请先配置 API Token!', 'info');
                } else {
                    this.tokenInput.value = this.apiToken;
                    this.updateTokenStatus('valid', '✅ Token 已配置');
                    this.showMainAppSection();
                    await this.checkLoginStatus(); // 初始检查登录状态
                }
            }

            showTokenSection() {
                this.tokenSection.style.display = 'block';
                this.mainAppSection.style.display = 'none';
                this.loginSection.style.display = 'none';
            }

            showMainAppSection() {
                this.tokenSection.style.display = 'none';
                this.mainAppSection.style.display = 'block';
                // 登录部分根据 isLoggedIn 状态控制
                if (this.isLoggedIn) {
                    this.loginSection.style.display = 'none';
                } else {
                    this.loginSection.style.display = 'block';
                }
            }

            updateTokenStatus(type, message) {
                this.tokenStatusEl.textContent = message;
                this.tokenStatusEl.style.color = type === 'valid' ? 'green' : 'red';
            }

            saveToken() {
                const token = this.tokenInput.value.trim();
                if (!token) {
                    this.showAlert('请输入 Token', 'error');
                    return;
                }
                this.apiToken = token;
                localStorage.setItem('weibo_proxy_token', token);
                this.updateTokenStatus('valid', '✅ Token 已保存');
                this.showAlert('Token 保存成功', 'success');

                // 保存后自动检查登录状态
                this.checkLoginStatus(); // 移除了 setTimeout
            }

            async fetchApi(endpoint, options = {}) {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiToken}`,
                        ...options.headers,
                    };

                    const response = await fetch(`${this.apiBaseUrl}/api${endpoint}`, {
                        ...options,
                        headers,
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        const errorMessage = data.error || '未知错误';
                        console.error(`API Error (${endpoint}):`, errorMessage);
                        throw new Error(errorMessage);
                    }
                    return data;
                } catch (error) {
                    console.error(`Fetch Error (${endpoint}):`, error);
                    this.showAlert(`请求失败: ${error.message}`, 'error');
                    throw error;
                }
            }

            async checkLoginStatus() {
                this.updateLoginStatus('检测中...');
                this.qrcodeImage.style.display = 'none';
                this.qrcodeMessage.textContent = '检测中...';
                try {
                    const data = await this.fetchApi('/status');
                    this.isLoggedIn = data.isLoggedIn;
                    if (this.isLoggedIn) {
                        this.updateLoginStatus('✅ 已登录');
                        this.showAlert('登录状态：已登录', 'success');
                        this.loginSection.style.display = 'none'; // 隐藏登录二维码区域
                        this.weiboContentInput.disabled = false;
                        this.postWeiboBtn.disabled = false;
                    } else {
                        this.updateLoginStatus('❌ 未登录');
                        this.showAlert('登录状态：未登录，请扫描二维码登录', 'info');
                        this.loginSection.style.display = 'block'; // 显示登录二维码区域
                        this.weiboContentInput.disabled = true;
                        this.postWeiboBtn.disabled = true;
                        this.getQRCode(); // 自动获取二维码
                    }
                } catch (error) {
                    this.updateLoginStatus('加载失败');
                    this.isLoggedIn = false;
                    this.loginSection.style.display = 'block'; // 显示登录二维码区域
                    this.weiboContentInput.disabled = true;
                    this.postWeiboBtn.disabled = true;
                    this.showAlert(`检查登录状态失败: ${error.message}`, 'error');
                }
            }

            async getQRCode() {
                this.qrcodeImage.style.display = 'none';
                this.qrcodeImage.src = '';
                this.qrcodeMessage.textContent = '正在获取二维码...';
                try {
                    const data = await this.fetchApi('/qrcode');
                    if (data.qrcode) {
                        this.qrcodeImage.src = data.qrcode;
                        this.qrcodeImage.style.display = 'block';
                        this.qrcodeMessage.textContent = '请使用微博 App 扫描上方二维码登录';
                        this.showAlert('二维码已更新，请扫描', 'info');
                    } else if (data.isLoggedIn) {
                        this.updateLoginStatus('✅ 已登录');
                        this.showAlert('用户已登录，无需二维码', 'success');
                        this.loginSection.style.display = 'none';
                        this.isLoggedIn = true;
                        this.weiboContentInput.disabled = false;
                        this.postWeiboBtn.disabled = false;
                    } else {
                        this.qrcodeMessage.textContent = '获取二维码失败，请重试';
                        this.showAlert('获取二维码失败，请重试', 'error');
                    }
                } catch (error) {
                    this.qrcodeMessage.textContent = '获取二维码失败';
                    this.showAlert(`获取二维码失败: ${error.message}`, 'error');
                }
            }

            async postWeibo() {
                const content = this.weiboContentInput.value.trim();
                if (!content) {
                    this.showAlert('微博内容不能为空', 'error');
                    return;
                }
                if (content.length > 140) {
                    this.showAlert('微博内容不能超过140字', 'error');
                    return;
                }

                this.setPostButtonState(true); // 禁用按钮并显示加载状态

                try {
                    await this.fetchApi('/post', {
                        method: 'POST',
                        body: JSON.stringify({ content }),
                    });
                    this.showAlert('微博发布成功！', 'success');
                    this.weiboContentInput.value = ''; // 清空内容
                    this.updateCharCount('');
                } catch (error) {
                    // 错误已在 fetchApi 中处理并显示
                } finally {
                    this.setPostButtonState(false); // 恢复按钮状态
                }
            }

            async clearSession() {
                if (!confirm('确定要清除会话吗？这会让你退出登录。')) {
                    return;
                }
                try {
                    await this.fetchApi('/clear-session', { method: 'POST' });
                    this.showAlert('会话已清除，请重新登录', 'success');
                    this.isLoggedIn = false;
                    this.updateLoginStatus('❌ 未登录');
                    this.showMainAppSection(); // 重新显示主区域，会触发二维码获取
                    this.weiboContentInput.disabled = true;
                    this.postWeiboBtn.disabled = true;
                } catch (error) {
                    // 错误已在 fetchApi 中处理并显示
                }
            }

            setPostButtonState(isLoading) {
                const originalText = '发布微博';
                const loadingText = '发布中...';
                if (isLoading) {
                    this.postWeiboBtn.disabled = true;
                    this.postWeiboBtn.textContent = loadingText;
                } else {
                    this.postWeiboBtn.disabled = false;
                    this.postWeiboBtn.textContent = originalText;
                }
            }
            updateCharCount(content) {
                const count = content.length;
                const charCountEl = document.getElementById('charCount');
                charCountEl.textContent = `${count}/140`;
                
                charCountEl.className = 'char-count';
                if (count > 120) {
                    charCountEl.classList.add('warning');
                }
                if (count > 140) {
                    charCountEl.classList.add('error');
                }
            }
            updateLoginStatus(message) {
                document.getElementById('loginStatus').textContent = message;
            }
            showAlert(message, type = 'info') {
                const alertContainer = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                
                alertContainer.innerHTML = '';
                alertContainer.appendChild(alert);
                
                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 3000);
                }
            }
            clearAlerts() {
                document.getElementById('alertContainer').innerHTML = '';
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new WeiboProxy();
        });
    </script>
</body>
</html>
